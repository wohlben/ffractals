# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Commands

```bash
npm run dev        # start dev server on port 3000
npm run build      # production build
npm run test       # run vitest tests
npm run lint       # biome lint
npm run format     # biome format
npm run check      # biome check (lint + format combined)
```

### Data update scripts (run as needed)
```bash
npm run update:protosets       # fetch latest game data from dsp-wiki.com
npm run update:icons           # update icon mappings
npm run download:images        # download building images
npm run check:mappings         # verify icon mappings are consistent
npm run update:building-details # scrape building stats from wiki
```

## Architecture

This is a **Dyson Sphere Program (DSP) production calculator** — a React SPA that lets players plan factory production chains, visualize them as graphs, and calculate resource/facility requirements.

### Stack

- **TanStack Start** (SSR-capable React framework) + **TanStack Router** (file-based routing)
- **@xyflow/react** for the interactive production graph canvas
- **@tanstack/store** for global state (no Redux/Zustand)
- **Tailwind CSS v4** + **shadcn/ui** component primitives
- **Biome** for linting/formatting (tabs, double quotes)
- **Vitest** + **@testing-library/react** for tests
- Path alias `@/` maps to `src/`

### Data layer (`src/lib/data/`)

- `src/assets/protosets.json` — raw DSP game data (items, recipes, techs, themes, veins). Updated via `npm run update:protosets`.
- `src/assets/building-details.json` — scraped facility stats (speed multipliers). Updated via `npm run update:building-details`.
- `DSPData` class (`src/lib/data/dsp-data.ts`) — static class with pre-computed lookup maps and derived sets loaded from protosets. All game data access goes through this class.
- `BuildingDetailsService` (`src/lib/data/building-details-service.ts`) — maps building names to item IDs and parses speed multipliers from scraped wiki data.
- `src/lib/data/models.ts` — TypeScript interfaces mirroring the protoset JSON schema (`Item`, `Recipe`, `Tech`, `Theme`, `Vein`).

### Calculator engine (`src/lib/calculator/`)

- `models.ts` — domain types: `CalculationElement` (a node in the production tree), `CalculationTarget` (a user-specified output goal), `CalculationState`, `ElementSource` (recipe | mining | extraction | gathering), `FacilityConfig`, proliferator multipliers.
- `utils.ts` — pure functions for rate math: `expandElementWithRecipe`, `setElementToMining`, `setElementToExtraction`, `calculateResourceNeeds`, `calculateFacilitySummary`, `calculateRateBreakdown`.

The calculator models a production tree as a flat `Record<string, CalculationElement>` where each element holds an array of child element IDs (`inputs`). Tree traversal always starts from a `CalculationTarget.rootElementId`.

### State management (`src/lib/stores/calculator-store.ts`)

Single `@tanstack/store` instance (`calculatorStore`) holds `CalculatorState`. State is persisted to `localStorage` under key `dsp-calculator-state-v1` and rehydrated client-side on load. All mutation functions are exported from the store module directly (not methods on the store). The `useCalculator()` hook (`src/hooks/use-calculator.ts`) wraps the store for component consumption.

### Graph rendering (`src/lib/graph/`, `src/components/graph/`)

- `src/lib/graph/builder.ts` — `buildGraphFromState()` converts the flat element map into `@xyflow/react` `Node[]` and `Edge[]`. Node types: `recipe`, `mining`, `extraction`.
- Custom node components: `RecipeNode`, `MiningNode`, `ExtractionNode` in `src/components/graph/`.
- `CalculatorGraph` component wires xyflow with the store and handles node drag → `updateNodePosition`.

### Routes (`src/routes/`)

- `/` — landing/home page with quick-start
- `/calculator` — main graph view (`CalculatorGraph`)
- `__root.tsx` — root layout: `Sidebar` (left) + `<Outlet>` (right) + `RecipeSelector` modal overlay

The `RecipeSelector` modal (`src/components/modals/RecipeSelector.tsx`) is triggered by clicking a graph node, stored as `selectedElementId` in the calculator store.

### Routing note

`src/routeTree.gen.ts` is auto-generated by the TanStack Router plugin — do not edit it manually. New routes are added by creating files in `src/routes/`.
